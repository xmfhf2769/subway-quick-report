/**
 * ì—­ë³„ ì „í™”ë²ˆí˜¸ í˜ì´ì§€ JavaScript
 * ê²€ìƒ‰, í•„í„°ë§, ì „í™” ì—°ê²° ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
 */

/* global StationData */

class StationPhoneManager {
  constructor() {
    this.currentRegion = 'all';
    this.currentStations = [];
    this.searchTerm = '';
    
    // DOM ìš”ì†Œ
    this.elements = {
      searchInput: null,
      searchButton: null,
      filterTabs: null,
      stationsGrid: null,
      stationsCount: null,
            loadingStations: null,
      noResults: null
    };

    this.init();
  }

  // ì´ˆê¸°í™”
  init() {
    this.bindElements();
    this.bindEvents();
    this.initTheme();
    this.loadStations();
  }

  // DOM ìš”ì†Œ ë°”ì¸ë”©
  bindElements() {
    this.elements.searchInput = document.getElementById('station-search');
    this.elements.searchButton = document.getElementById('search-button');
    this.elements.filterTabs = document.querySelectorAll('.filter-tab');
    this.elements.stationsGrid = document.getElementById('stations-grid');
    this.elements.stationsCount = document.getElementById('stations-count');
    this.elements.loadingStations = document.getElementById('loading-stations');
    this.elements.noResults = document.getElementById('no-results');
    this.elements.themeToggle = document.getElementById('theme-toggle');
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  bindEvents() {
    // ê²€ìƒ‰ ì´ë²¤íŠ¸
    if (this.elements.searchInput) {
      this.elements.searchInput.addEventListener('input', (e) => {
        this.searchTerm = e.target.value;
        this.debounce(this.filterAndDisplayStations.bind(this), 300)();
      });

      this.elements.searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          this.filterAndDisplayStations();
        }
      });
    }

    if (this.elements.searchButton) {
      this.elements.searchButton.addEventListener('click', () => {
        this.filterAndDisplayStations();
      });
    }

    // í•„í„° íƒ­ ì´ë²¤íŠ¸
    this.elements.filterTabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        this.setActiveRegion(e.target.dataset.region);
      });
    });

    // í…Œë§ˆ í† ê¸€ ì´ë²¤íŠ¸
    if (this.elements.themeToggle) {
      this.elements.themeToggle.addEventListener('click', () => {
        this.toggleTheme();
      });
    }

    // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        this.elements.searchInput?.focus();
      }
    });
  }

  // í…Œë§ˆ ì´ˆê¸°í™”
  initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    this.updateThemeButton(savedTheme);
  }

  // í…Œë§ˆ í† ê¸€
  toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    this.updateThemeButton(newTheme);
  }

  // í…Œë§ˆ ë²„íŠ¼ ì—…ë°ì´íŠ¸
  updateThemeButton(theme) {
    if (this.elements.themeToggle) {
      this.elements.themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      this.elements.themeToggle.setAttribute('aria-label', 
        theme === 'dark' ? 'ë¼ì´íŠ¸ ëª¨ë“œë¡œ ë³€ê²½' : 'ë‹¤í¬ ëª¨ë“œë¡œ ë³€ê²½'
      );
    }
  }

  // ì—­ ë°ì´í„° ë¡œë“œ
  loadStations() {
    this.showLoading(true);
    
    // StationDataê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    const waitForData = () => {
      if (window.StationData && window.StationData.stations.length > 0) {
        this.filterAndDisplayStations();
        this.showLoading(false);
      } else {
        setTimeout(waitForData, 100);
      }
    };
    
    waitForData();
  }

  // í™œì„± ì§€ì—­ ì„¤ì •
  setActiveRegion(region) {
    this.currentRegion = region;
    
    // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
    this.elements.filterTabs.forEach(tab => {
      tab.classList.toggle('active', tab.dataset.region === region);
      tab.setAttribute('aria-selected', tab.dataset.region === region);
    });
    
    this.filterAndDisplayStations();
  }

  // ì—­ í•„í„°ë§ ë° í‘œì‹œ
  filterAndDisplayStations() {
    if (!window.StationData) {
      console.warn('StationDataê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }

    // ì§€ì—­ë³„ í•„í„°ë§
    let stations = window.StationData.getStationsByRegion(this.currentRegion);
    
    // ê²€ìƒ‰ì–´ í•„í„°ë§
    if (this.searchTerm.trim()) {
      stations = stations.filter(station =>
        station.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
        station.address.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
        station.line.toLowerCase().includes(this.searchTerm.toLowerCase())
      );
    }

    this.currentStations = stations;
    this.displayStations(stations);
    this.updateStationsCount(stations.length);
  }

  // ì—­ ëª©ë¡ í‘œì‹œ
  displayStations(stations) {
    if (!this.elements.stationsGrid) return;

    if (stations.length === 0) {
      this.showNoResults(true);
      this.elements.stationsGrid.innerHTML = '';
      return;
    }

    this.showNoResults(false);
    
    this.elements.stationsGrid.innerHTML = stations.map(station => 
      this.createStationCard(station)
    ).join('');

    // ì „í™” ì•¡ì…˜ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    this.bindPhoneActions();
  }

  // ì—­ ì¹´ë“œ ìƒì„±
  createStationCard(station) {
    const lineDisplayName = this.getLineDisplayName(station.line);
    
    return `
      <div class="station-card" data-station-id="${station.id}">
        <div class="station-header">
          <div class="station-info">
            <div class="station-name">
              ğŸš‡ ${station.name}
              <span class="station-line" data-line="${station.line}">
                ${lineDisplayName}
              </span>
            </div>
            <div class="station-address">ğŸ“ ${station.address}</div>
            <div class="station-phone">ğŸ“ ${station.phone}</div>
          </div>
        </div>
        <div class="phone-actions">
          <button class="phone-action call" data-phone="${station.phone}" data-station="${station.name}">
            ğŸ“ ì „í™”ê±¸ê¸°
          </button>
          <button class="phone-action sms" data-phone="${station.phone}" data-station="${station.name}">
            ğŸ’¬ SMS
          </button>
          <button class="phone-action copy" data-phone="${station.phone}" data-station="${station.name}">
            ğŸ“‹ ë³µì‚¬
          </button>
        </div>
      </div>
    `;
  }

  // í˜¸ì„  í‘œì‹œëª… ê°€ì ¸ì˜¤ê¸°
  getLineDisplayName(line) {
    const lineNames = {
      '1': '1í˜¸ì„ ',
      '2': '2í˜¸ì„ ', 
      '3': '3í˜¸ì„ ',
      '4': '4í˜¸ì„ ',
      '5': '5í˜¸ì„ ',
      '6': '6í˜¸ì„ ',
      '7': '7í˜¸ì„ ',
      '8': '8í˜¸ì„ ',
      '9': '9í˜¸ì„ ',
      'incheon1': 'ì¸ì²œ1í˜¸ì„ ',
      'incheon2': 'ì¸ì²œ2í˜¸ì„ ',
      'busan1': 'ë¶€ì‚°1í˜¸ì„ ',
      'busan2': 'ë¶€ì‚°2í˜¸ì„ ',
      'busan3': 'ë¶€ì‚°3í˜¸ì„ ',
      'busan4': 'ë¶€ì‚°4í˜¸ì„ ',
      'daegu1': 'ëŒ€êµ¬1í˜¸ì„ ',
      'daegu2': 'ëŒ€êµ¬2í˜¸ì„ ',
      'daegu3': 'ëŒ€êµ¬3í˜¸ì„ ',
      'daejeon1': 'ëŒ€ì „1í˜¸ì„ ',
      'gwangju1': 'ê´‘ì£¼1í˜¸ì„ '
    };
    
    return lineNames[line] || line;
  }

  // ì „í™” ì•¡ì…˜ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  bindPhoneActions() {
    // ì „í™”ê±¸ê¸° ë²„íŠ¼
    document.querySelectorAll('.phone-action.call').forEach(button => {
      button.addEventListener('click', (e) => {
        const phone = e.target.dataset.phone;
        const station = e.target.dataset.station;
        this.makeCall(phone, station);
      });
    });

    // SMS ë²„íŠ¼
    document.querySelectorAll('.phone-action.sms').forEach(button => {
      button.addEventListener('click', (e) => {
        const phone = e.target.dataset.phone;
        const station = e.target.dataset.station;
        this.sendSMS(phone, station);
      });
    });

    // ë³µì‚¬ ë²„íŠ¼
    document.querySelectorAll('.phone-action.copy').forEach(button => {
      button.addEventListener('click', (e) => {
        const phone = e.target.dataset.phone;
        const station = e.target.dataset.station;
        this.copyPhone(phone, station);
      });
    });
  }

  // ì „í™”ê±¸ê¸°
  makeCall(phone, station) {
    if (this.isMobile()) {
      window.location.href = `tel:${phone}`;
    } else {
      this.showToast(`${station} (${phone})`, 'ëª¨ë°”ì¼ì—ì„œ ì „í™”ë¥¼ ê±¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
    }
  }

  // SMS ë³´ë‚´ê¸°
  sendSMS(phone, station) {
    if (this.isMobile()) {
      const message = `ì•ˆë…•í•˜ì„¸ìš”. ${station} ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.`;
      window.location.href = `sms:${phone}?body=${encodeURIComponent(message)}`;
    } else {
      this.showToast(`${station} (${phone})`, 'SMSëŠ” ëª¨ë°”ì¼ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤');
    }
  }

  // ì „í™”ë²ˆí˜¸ ë³µì‚¬
  async copyPhone(phone, station) {
    try {
      await navigator.clipboard.writeText(phone);
      this.showToast(`${station}`, 'ì „í™”ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch (err) {
      console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
      this.showToast(`${station} (${phone})`, 'ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
  }

  // ëª¨ë°”ì¼ ê¸°ê¸° í™•ì¸
  isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
  showToast(title, message) {
    // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
      existingToast.remove();
    }

    // ìƒˆ í† ìŠ¤íŠ¸ ìƒì„±
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `
      <div class="toast-content">
        <strong>${title}</strong>
        <p>${message}</p>
      </div>
    `;

    // í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€
    toast.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-primary);
      border: 2px solid var(--primary-color);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      min-width: 300px;
      max-width: 90vw;
      animation: slideUp 0.3s ease-out;
    `;

    document.body.appendChild(toast);

    // 3ì´ˆ í›„ ì œê±°
    setTimeout(() => {
      toast.style.animation = 'slideDown 0.3s ease-in';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // ì—­ ê°œìˆ˜ ì—…ë°ì´íŠ¸
  updateStationsCount(count) {
    if (this.elements.stationsCount) {
      this.elements.stationsCount.textContent = `ì´ ${count}ê°œ ì—­`;
    }
  }

  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  showLoading(show) {
    if (this.elements.loadingStations) {
      this.elements.loadingStations.style.display = show ? 'flex' : 'none';
    }
  }

  // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ í‘œì‹œ
  showNoResults(show) {
    if (this.elements.noResults) {
      this.elements.noResults.style.display = show ? 'block' : 'none';
    }
  }

  // ë””ë°”ìš´ìŠ¤ ìœ í‹¸ë¦¬í‹°
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
}

// í† ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
const style = document.createElement('style');
style.textContent = `
  @keyframes slideUp {
    from {
      transform: translateX(-50%) translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes slideDown {
    from {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    to {
      transform: translateX(-50%) translateY(100%);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
  new StationPhoneManager();
}); 